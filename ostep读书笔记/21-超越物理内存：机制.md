我只有 16G 的内存，是否我只能运行需要的内存在 16G 以内的程序？并不是，我们还能利用磁盘，营造一种巨大虚拟空间的假象。

#### 交换空间

在硬盘上开辟一部分空间用于物理页的移入和移出。在操作系统中，一般这样的空间称为交换空间（swap space），因为我们将内存中的页交换到其中，并在需要的时候又交换回去。

当然原本的存储区域也可以作为交换区，当内存不够的时候，操作系统可以暂时覆盖掉某一部分内存，需要的时候重新从磁盘读取。

#### 存在位

标识该地址是否在物理内存中。如果存在位设置为 零，则页不在内存中，而在硬盘上。访问不在物理内存中的页，这种行为通常被称为页错误（page fault）。

#### 页错误

如果一个页不存在，它已被交换到硬盘，在处理页错误的时候，操作系统需要将该页交换到内存中。

当硬盘 I/O 完成时，操作系统会更新页表，将此页标记为存在，更新页表项（PTE）的 PFN 字段以记录新获取页的内存位置，并重试指令。下一次重新访问 TLB 还是未命中，然 而这次因为页在内存中，因此会将页表中的地址更新到 TLB 中（也可以在处理页错误时更 新 TLB 以避免此步骤）。最后的重试操作会在 TLB 中找到转换映射，从已转换的内存物理 地址，获取所需的数据或指令。

请注意，当 I/O 在运行时，进程将处于阻塞（blocked）状态。因此，当页错误正常处理时，操作系统可以自由地运行其他可执行的进程。

#### 内存满了怎么办

利用页交换策略，将某一部分舍弃，从而为交换空间换过来的内存腾位置。

#### 页错误处理流程

1. 该页存在（present）且有效（valid），在这种情况下，TLB 未命中处理程序可以简单地从 PTE 中获取 PFN，然后重试指令（这次 TLB 会命中）
2. 页错误处理程序需要运行。虽然这是 进程可以访问的合法页（毕竟是有效的），但它并不在物理内存中。
3. 访问的是 一个无效页，可能由于程序中的错误，被操作系统 kill 。

#### 交换何时真正发生

不会全满，操作系统会预留一点空间。为了保证有少量的空闲内存，大多数操作系统会设置高水位线（High Watermark，HW）和低水位线（Low Watermark，LW），来帮助决定何时从内存中清除页。原理是这样：当操 作系统发现有少于 LW 个页可用时，后台负责释放内存的线程会开始运行，直到有 HW 个 可用的物理页。这个后台线程有时称为交换守护进程（swap daemon）或页守护进程（page daemon），它然后会很开心地进入休眠状态，因为它毕竟为操作系统释放了一些内存。

同时执行多个交换过程来优化性能。